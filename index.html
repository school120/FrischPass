<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FrischPass – Early Dismissal</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1020;color:#fff;text-align:center;padding:40px}
  #clock{font-size:18px;color:#cfd8ff;margin-bottom:20px}
  input[type=text]{width:280px;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#0f1530;color:#fff;font-size:18px;text-align:center}
  #go{margin-top:18px;padding:14px 22px;border:none;border-radius:10px;background:#91011c;color:#fff;font-weight:700;font-size:18px;cursor:pointer}
  #status{margin-top:12px;font-size:16px;color:#9fe0ad}
</style>
</head><body>
<h1>Sign Out – Main Office</h1>
<div id="clock"></div>
<input id="legacy_id" type="text" placeholder="Scan or type Legacy Student ID" autocomplete="off" autofocus />
<button id="go">Sign Out</button>
<div id="status"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const VC_ORIGIN = "https://checkin.veracross.com";
const VC_URL    = "https://checkin.veracross.com/frisch/kiosk/soutoffice";
const LOGO_URL  = "https://school120.github.io/FrischPass/logo.png";
const ROSTER_URL= "roster.csv";

let vcWin = null;
const roster = new Map();

setInterval(()=>{document.getElementById('clock').textContent=new Date().toLocaleString();},1000);

(async function loadRoster(){
  try{
    const txt = await (await fetch(ROSTER_URL,{cache:'no-store'})).text();
    const p = Papa.parse(txt,{header:true,skipEmptyLines:true});
    p.data.forEach(r=>{
      const id=(r["Legacy Student ID"]||"").trim();
      if(id) roster.set(id,{name:(r["Full Name"]||"").trim(),grade:(r["Current Grade"]||"").trim()});
    });
    document.getElementById('status').textContent=`Roster loaded: ${roster.size} students.`;
  }catch{}
})();

function openVC(){ try{ vcWin = window.open(VC_URL,'veracross_tab'); }catch{} }

function sendToVC(id){
  if(!vcWin || vcWin.closed) openVC();
  setTimeout(()=>{ try{ vcWin.postMessage({type:'frisch_legacy_id', id:id}, VC_ORIGIN); }catch{} }, 600);
}

window.addEventListener('message', (e)=>{
  if(e.origin !== VC_ORIGIN) return;
  const d = e.data || {};
  if(d.type === 'frisch_ok'){
    const info = roster.get(String(d.id)||"") || {name:"Unknown Student", grade:""};
    printPass(info.name, info.grade);
    ready();
  }else if(d.type === 'frisch_err'){
    document.getElementById('status').style.color = '#ffb3a1';
    document.getElementById('status').textContent = 'Submit failed';
    ready();
  }
});

function submit(){
  const inp = document.getElementById('legacy_id');
  const id = inp.value.trim();
  if(!id) return;
  document.getElementById('status').style.color='#cfd8ff';
  document.getElementById('status').textContent='Submitting…';
  sendToVC(id); // VC tab (with inject.js) will CSRF-post and reply
  inp.value='';
}

function ready(){
  const inp = document.getElementById('legacy_id');
  inp.value=''; inp.focus();
  document.getElementById('status').style.color='#9fe0ad';
  document.getElementById('status').textContent='Done';
}

function printPass(name,grade){
  const now=new Date().toLocaleString();
  const w=window.open('','printpass','width=900,height=560,left=-9999,top=-9999');
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>FrischPass</title>
  <style>
    @page { size: 100mm 62mm; margin: 3.8mm }
    @media print { html,body{width:100mm;height:62mm;-webkit-print-color-adjust:exact;print-color-adjust:exact} }
    body{margin:0;width:calc(100mm - 7.6mm);height:calc(62mm - 7.6mm);font-family:Arial,sans-serif;position:relative;overflow:hidden}
    .wm{position:absolute;inset:0;background:url(${LOGO_URL}) no-repeat center center;background-size:85% auto;opacity:.10;pointer-events:none}
    .lab{position:relative;width:100%;height:100%;border:.6mm solid #000;box-sizing:border-box;padding:3mm 4mm;display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start}
    h1{margin:0 0 1.4mm;font-size:7mm;line-height:1.05}
    .line{font-size:4.2mm;line-height:1.25;margin-top:.8mm}
    .big{font-size:5mm;font-weight:bold;margin-top:2mm}
  </style></head><body>
  <div class="wm"></div>
  <div class="lab">
    <h1>FRISCHPASS – EARLY DISMISSAL</h1>
    <div class="line"><b>${escapeHtml(name)}</b></div>
    <div class="line">Grade: ${escapeHtml(grade||'')}</div>
    <div class="big">Signed out: ${escapeHtml(now)}</div>
  </div>
  <script>window.print();setTimeout(()=>window.close(),300);<\/script>
  </body></html>`);
  w.document.close();
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));}

document.getElementById('go').addEventListener('click', submit);
document.getElementById('legacy_id').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); submit(); }});
window.addEventListener('load', ()=>{ openVC(); document.getElementById('legacy_id').focus(); });
</script>
</body></html>
