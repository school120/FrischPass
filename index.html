<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Frisch Kiosk – Early Dismissal</title>
<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:#0b1020;
  color:#fff;
  text-align:center;
  padding:40px;
}
#clock{
  font-size:18px;
  color:#cfd8ff;
  margin-bottom:20px;
}
input[type=text]{
  width:280px;
  padding:14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.18);
  background:#0f1530;
  color:#fff;
  font-size:18px;
  text-align:center;
}
#sign_in_button input[type=button]{
  margin-top:20px;
  padding:14px 22px;
  border:none;
  border-radius:10px;
  background:#91011c;
  color:#fff;
  font-weight:700;
  font-size:18px;
  cursor:pointer;
}
#response{
  margin-top:20px;
  font-size:16px;
  color:#9fe0ad;
}
</style>
</head>
<body>

<h1>Sign Out Main Office</h1>
<div id="clock"></div>

<input type="text" id="legacy_id" placeholder="Scan or type Legacy Student ID" autocomplete="off" autofocus />
<div id="sign_in_button"><input type="button" value="Sign Out" onclick="handleScan()" /></div>
<div id="response"></div>

<!-- PapaParse for robust CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const roster = new Map();

// Clock
setInterval(() => {
  document.getElementById("clock").textContent = new Date().toLocaleString();
}, 1000);

// Load roster.csv
async function loadRoster(){
  try{
    const res = await fetch("roster.csv", {cache:"no-store"});
    if(!res.ok) throw new Error();
    const text = await res.text();
    const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
    roster.clear();
    parsed.data.forEach(row => {
      const id = (row["Legacy Student ID"] || "").trim();
      const name = (row["Full Name"] || "").trim();
      const grade = (row["Current Grade"] || "").trim();
      if(id) roster.set(id, {name, grade});
    });
    document.getElementById("response").textContent =
      `Roster loaded: ${roster.size} students.`;
  } catch(e){
    document.getElementById("response").textContent =
      "⚠️ roster.csv not found or invalid format.";
  }
}
loadRoster();

// Handle scan
function handleScan(){
  const idField = document.getElementById("legacy_id");
  const id = idField.value.trim();
  const resp = document.getElementById("response");

  if(!id){
    resp.style.color="#ffb3a1";
    resp.textContent="Scan or enter an ID.";
    return;
  }

  const info = roster.get(id) || {name:"Unknown Student", grade:""};
  const {name, grade} = info;

  resp.style.color="#9fe0ad";
  resp.textContent = `Signed out: ${name} (${grade})`;

  printPass(name, grade);

  // Clear input immediately for next scan
  idField.value = "";
  idField.focus();
}

// Print label (no ID shown)
function printPass(name, grade){
  const now = new Date().toLocaleString();
  const w = window.open("", "printpass", "width=400,height=260,left=-9999,top=-9999");
  w.document.write(`<!doctype html>
  <html><head><meta charset=utf-8><title>FrischPass</title>
    <style>
      @page { size:3.94in 2.44in; margin:0.15in }
      body { margin:0; font-family:Arial,sans-serif }
      .lab {
        width:3.64in;
        height:2.14in;
        border:2px solid #000;
        padding:.08in .12in;
      }
      h1 { margin:0 0 4px; font-size:18px }
      .big { font-size:16px; font-weight:bold; margin-top:6px }
    </style>
  </head><body>
    <div class='lab'>
      <h1>FRISCHPASS – EARLY DISMISSAL</h1>
      <div><b>${name}</b></div>
      <div>Grade: ${grade || ""}</div>
      <div class='big'>Signed out: ${now}</div>
    </div>
    <script>window.print();setTimeout(()=>window.close(),300);<\/script>
  </body></html>`);
  w.document.close();
}

document.getElementById("legacy_id").addEventListener("keydown", e => {
  if(e.key === "Enter"){
    e.preventDefault();
    handleScan();
  }
});
</script>
</body>
</html>
